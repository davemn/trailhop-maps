<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="shortcut icon" href="img/favicon.png">
    <title>Leaflet demo</title>
    <!-- Bootstrap core CSS + customizations -->
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css">
    <link rel="stylesheet" type="text/css" href="index.css">
  </head>
  <body>
    <div id="map"></div>
  
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/javascript" src="bower_components/jquery/dist/jquery.js"></script>
    <script type="text/javascript" src="bower_components/leaflet/dist/leaflet-src.js"></script>
    <script>
      (function(exports, $){
        exports.deltaTime = 0;
        exports.time = 0; // time since start of game, in seconds, accurate to 1 ms
        exports.frameCount = 0;
        
        // 1 ms accuracy
        function msToSec(ms){
          return +(Math.round(ms) + 'e-3');
        }
        
        function step(){
          // perf.now() returns millis, e.g. 1200.001 = 1.2 secs + 1/1000 ms
          var frameStart = msToSec(performance.now());
          
          exports.deltaTime = frameStart - exports.time;
          exports.time = frameStart;
          
          exports.frameCount++;
          requestAnimationFrame(step);
        }
        
        requestAnimationFrame(step);
        
      })(window.Time = {}, jQuery);
      
      var MapContainer = function(elemId){
        // this.map = L.map(elemId).setView([51.505, -0.09], 13);
        this.map = L.map(elemId, {
          center: [0,0],
          zoom: 0,
          crs: L.CRS.Simple
        });
        
        var layer = L.tileLayer('http://localhost/.stage/github/trailhop-maps/tile-svc/{z}/{x}/{y}', {
          // maxZoom: 18,
          continuousWorld: true,
          tms: true
        });
        layer.addTo(this.map);
      };
      
      // ===
      
      var $App;
      var stepPeriod = 0.5; // seconds / step
      var elapsedSinceStep = 0.0;
      
      function init(){
        var $App = $({
          map: new MapContainer('map')
        });
        
        $App.on('plot', function(evt, coords){
          console.log(coords);
        });
      }
            
      var StreamEventNames = {
        ERROR: 0,
        END: 1,
        DATA: 2,
      };
      
      function CoordinateStream(){
        if(!navigator.geolocation)
          throw new Error("Browser doesn't support geolocation");
        
        navigator.geolocation.watchPosition(this._watch.bind(this), this._err.bind(this));
        this._listeners = {
          StreamEventNames.ERROR: [],
          StreamEventNames.END: [],
          StreamEventNames.DATA: []
        };
      }
      CoordinateStream.prototype.listenTo = function(evtName, cb){
        this._listeners[evtName].push(cb);
        // switch(evtName){
        //   case StreamEventNames.ERROR:
        //     break;
        //   case StreamEventNames.END:
        //     break;
        //   case StreamEventNames.DATA:
        //     
        //     break;
        //   default:
        // }
      };
      CoordinateStream.prototype._notifyAll = function(evtName, argsArray){
        var count = this._listeners[evtName].length;
        for(var i=0; i < count; i++){
          // this._listeners[evtName][i](pos.coords);
          if(!argsArray || argsArray.length === 0)
            this._listeners[evtName][i].apply(this);
          else
            this._listeners[evtName][i].apply(this, argsArray);
        }
      };
      CoordinateStream.prototype._watch = function(pos){
        this._notifyAll(StreamEventNames.DATA, [pos.coords]);
      };
      CoordinateStream.prototype._err = function(err){
        if(err.code === 1) { // permission denied
          this._notifyAll(StreamEventNames.END);
        }
        else {
          switch(err.code){
            default:
            case 0:
              this._notifyAll(StreamEventNames.ERROR, ['Unknown Error']);
              break;
            case 2:
              this._notifyAll(StreamEventNames.ERROR, ['Position Unavailable']);
              break;
            case 3:
              this._notifyAll(StreamEventNames.ERROR, ['Timeout']);
              break;
          }
        }
      };
      
      function step(){
        if(elapsedSinceStep >= stepPeriod){
          // only query location every STEPPERIOD seconds
          navigator.geolocation.getCurrentPosition(function(position) {
            // startPos = position;
            // document.getElementById('startLat').innerHTML = startPos.coords.latitude;
            // document.getElementById('startLon').innerHTML = startPos.coords.longitude;
            
            $App.trigger('plot', position.coords);
          }, function(err){
            // error.code can be:
            //   0: unknown error
            //   1: permission denied
            //   2: position unavailable (error response from locaton provider)
            //   3: timed out
          });
          
          elapsedSinceStep = 0.0;
        }
        
        elapsedSinceStep += Time.deltaTime;
        requestAnimationFrame(step);
      }
      
      $(document).ready(function(evt) {
        init();
        requestAnimationFrame(step);
      });
    </script>
  </body>
</html>
